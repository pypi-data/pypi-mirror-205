
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7. Extending Nikola &#8212; Nikola 8.1.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Nikola Internals" href="internals.html" />
    <link rel="prev" title="6. Template variables" href="template-variables.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="internals.html" title="8. Nikola Internals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="template-variables.html" title="6. Template variables"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Nikola 8.1.3 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7. </span>Extending Nikola</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="extending-nikola">
<h1><a class="toc-backref" href="#id1"><span class="section-number">7. </span>Extending Nikola</a><a class="headerlink" href="#extending-nikola" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Version</dt>
<dd class="field-odd"><p>8.1.3</p>
</dd>
<dt class="field-even">Author</dt>
<dd class="field-even"><p>Roberto Alsina &lt;<a class="reference external" href="mailto:ralsina&#37;&#52;&#48;netmanagers&#46;com&#46;ar">ralsina<span>&#64;</span>netmanagers<span>&#46;</span>com<span>&#46;</span>ar</a>&gt;</p>
</dd>
</dl>
<div class="contents alert alert-primary float-md-right topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#extending-nikola" id="id1">Extending Nikola</a></p>
<ul>
<li><p><a class="reference internal" href="#available-plugin-categories" id="id2">Available Plugin Categories</a></p>
<ul>
<li><p><a class="reference internal" href="#command-plugins" id="id3">Command Plugins</a></p></li>
<li><p><a class="reference internal" href="#templatesystem-plugins" id="id4">TemplateSystem Plugins</a></p></li>
<li><p><a class="reference internal" href="#task-plugins" id="id5">Task Plugins</a></p></li>
<li><p><a class="reference internal" href="#pagecompiler-plugins" id="id6">PageCompiler Plugins</a></p></li>
<li><p><a class="reference internal" href="#metadataextractor-plugins" id="id7">MetadataExtractor Plugins</a></p></li>
<li><p><a class="reference internal" href="#restextension-plugins" id="id8">RestExtension Plugins</a></p></li>
<li><p><a class="reference internal" href="#markdownextension-plugins" id="id9">MarkdownExtension Plugins</a></p></li>
<li><p><a class="reference internal" href="#signalhandler-plugins" id="id10">SignalHandler Plugins</a></p></li>
<li><p><a class="reference internal" href="#configplugin-plugins" id="id11">ConfigPlugin Plugins</a></p></li>
<li><p><a class="reference internal" href="#commentsystem-plugins" id="id12">CommentSystem Plugins</a></p></li>
<li><p><a class="reference internal" href="#shortcode-plugins" id="id13">Shortcode Plugins</a></p></li>
<li><p><a class="reference internal" href="#postscanner-plugins" id="id14">PostScanner Plugins</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#plugin-index" id="id15">Plugin Index</a></p></li>
<li><p><a class="reference internal" href="#path-link-resolution-mechanism" id="id16">Path/Link Resolution Mechanism</a></p></li>
<li><p><a class="reference internal" href="#template-hooks" id="id17">Template Hooks</a></p></li>
<li><p><a class="reference internal" href="#shortcodes" id="id18">Shortcodes</a></p>
<ul>
<li><p><a class="reference internal" href="#template-based-shortcodes" id="id19">Template-based Shortcodes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#state-and-cache" id="id20">State and Cache</a></p></li>
<li><p><a class="reference internal" href="#logging" id="id21">Logging</a></p></li>
<li><p><a class="reference internal" href="#template-and-dependency-injection" id="id22">Template and Dependency Injection</a></p></li>
</ul>
</li>
</ul>
</div>
<p class="lead">Nikola is extensible. Almost all its functionality is based on plugins,
and you can add your own or replace the provided ones.</p>
<p>Plugins consist of a metadata file (with <code class="docutils literal notranslate"><span class="pre">.plugin</span></code> extension) and
a Python module (a <code class="docutils literal notranslate"><span class="pre">.py</span></code> file) or package (a folder containing
a <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file.</p>
<p>To use a plugin in your site, you just have to put it in a <code class="docutils literal notranslate"><span class="pre">plugins</span></code>
folder in your site.</p>
<p>Plugins come in various flavours, aimed at extending different aspects
of Nikola.</p>
<section id="available-plugin-categories">
<h2><a class="toc-backref" href="#id2"><span class="section-number">7.1. </span>Available Plugin Categories</a><a class="headerlink" href="#available-plugin-categories" title="Permalink to this headline">¶</a></h2>
<section id="command-plugins">
<h3><a class="toc-backref" href="#id3"><span class="section-number">7.1.1. </span>Command Plugins</a><a class="headerlink" href="#command-plugins" title="Permalink to this headline">¶</a></h3>
<p>When you run <code class="docutils literal notranslate"><span class="pre">nikola</span> <span class="pre">--help</span></code> you will see something like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nikola <span class="nb">help</span>
<span class="go">Nikola is a tool to create static websites and blogs. For full documentation and more</span>
<span class="go">information, please visit https://getnikola.com/</span>


<span class="go">Available commands:</span>
<span class="go">nikola auto                 automatically detect site changes, rebuild</span>
<span class="go">                            and optionally refresh a browser</span>
<span class="go">nikola bootswatch_theme     given a swatch name from bootswatch.com and a</span>
<span class="go">                            parent theme, creates a custom theme</span>
<span class="go">nikola build                run tasks</span>
<span class="go">nikola check                check links and files in the generated site</span>
<span class="go">nikola clean                clean action / remove targets</span>
<span class="go">nikola console              start an interactive python console with access to</span>
<span class="go">                            your site and configuration</span>
<span class="go">nikola deploy               deploy the site</span>
<span class="go">nikola dumpdb               dump dependency DB</span>
<span class="go">nikola forget               clear successful run status from internal DB</span>
<span class="go">nikola help                 show help</span>
<span class="go">nikola ignore               ignore task (skip) on subsequent runs</span>
<span class="go">nikola import_blogger       import a blogger dump</span>
<span class="go">nikola import_feed          import a RSS/Atom dump</span>
<span class="go">nikola import_wordpress     import a WordPress dump</span>
<span class="go">nikola init                 create a Nikola site in the specified folder</span>
<span class="go">nikola list                 list tasks from dodo file</span>
<span class="go">nikola mincss               apply mincss to the generated site</span>
<span class="go">nikola new_post             create a new blog post or site page</span>
<span class="go">nikola run                  run tasks</span>
<span class="go">nikola serve                start the test webserver</span>
<span class="go">nikola strace               use strace to list file_deps and targets</span>
<span class="go">nikola theme                manage themes</span>
<span class="go">nikola version              print the Nikola version number</span>

<span class="go">nikola help                 show help / reference</span>
<span class="go">nikola help &lt;command&gt;       show command usage</span>
<span class="go">nikola help &lt;task-name&gt;     show task usage</span>
</pre></div>
</div>
<p>That will give you a list of all available commands in your version of Nikola.
Each and every one of those is a plugin. Let’s look at a typical example:</p>
<p>First, the <code class="docutils literal notranslate"><span class="pre">serve.plugin</span></code> file:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Core]</span>
<span class="na">Name</span> <span class="o">=</span> <span class="s">serve</span>
<span class="na">Module</span> <span class="o">=</span> <span class="s">serve</span>

<span class="k">[Documentation]</span>
<span class="na">Author</span> <span class="o">=</span> <span class="s">Roberto Alsina</span>
<span class="na">Version</span> <span class="o">=</span> <span class="s">0.1</span>
<span class="na">Website</span> <span class="o">=</span> <span class="s">https://getnikola.com</span>
<span class="na">Description</span> <span class="o">=</span> <span class="s">Start test server.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to publish your plugin on the Plugin Index, <a class="reference external" href="https://github.com/getnikola/plugins/blob/master/README.md">read
the docs for the Index</a>
(and the .plugin file examples and explanations).</p>
</div>
<p>For your own plugin, just change the values in a sensible way. The
<code class="docutils literal notranslate"><span class="pre">Module</span></code> will be used to find the matching Python module, in this case
<code class="docutils literal notranslate"><span class="pre">serve.py</span></code>, from which this is the interesting bit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nikola.plugin_categories</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="c1"># You have to inherit Command for this to be a</span>
<span class="c1"># command plugin:</span>

<span class="k">class</span> <span class="nc">CommandServe</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Start test server.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;serve&quot;</span>
    <span class="n">doc_usage</span> <span class="o">=</span> <span class="s2">&quot;[options]&quot;</span>
    <span class="n">doc_purpose</span> <span class="o">=</span> <span class="s2">&quot;start the test webserver&quot;</span>

    <span class="n">cmd_options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span>
            <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span>
            <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Port number&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span>
            <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;--address&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Address to bind&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start test server.&quot;&quot;&quot;</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;OUTPUT_FOLDER&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Missing &#39;</span><span class="si">{0}</span><span class="s2">&#39; folder?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_dir</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Exit code on failure. (return 0 not necessary)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
            <span class="n">httpd</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]),</span>
                            <span class="n">OurHTTPRequestHandler</span><span class="p">)</span>
            <span class="n">sa</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Serving HTTP on&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>As mentioned above, a plugin can have options, which the user can see by doing
<code class="docutils literal notranslate"><span class="pre">nikola</span> <span class="pre">help</span> <span class="pre">command</span></code> and can later use, for example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nikola <span class="nb">help</span> serve
<span class="go">nikola serve [options]</span>
<span class="go">start the test webserver</span>

<span class="go">Options:</span>
<span class="go">    -p ARG, --port=ARG</span>
<span class="go">        Port number [default: 8000]</span>
<span class="go">    -a ARG, --address=ARG</span>
<span class="go">        Address to bind [default: 127.0.0.1]</span>

<span class="gp">$ </span>nikola serve -p <span class="m">9000</span>
<span class="go">Serving HTTP on 127.0.0.1 port 9000 ...</span>
</pre></div>
</div>
<p>So, what can you do with commands? Well, anything you want, really. I have implemented
a sort of planet using it. So, be creative, and if you do something interesting,
let me know ;-)</p>
</section>
<section id="templatesystem-plugins">
<h3><a class="toc-backref" href="#id4"><span class="section-number">7.1.2. </span>TemplateSystem Plugins</a><a class="headerlink" href="#templatesystem-plugins" title="Permalink to this headline">¶</a></h3>
<p>Nikola supports Mako and Jinja2. If you prefer some other templating
system, then you will have to write a <code class="docutils literal notranslate"><span class="pre">TemplateSystem</span></code> plugin. Here’s how they work.
First, you have to create a <code class="docutils literal notranslate"><span class="pre">.plugin</span></code> file. Here’s the one for the Mako plugin:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Core]</span>
<span class="na">Name</span> <span class="o">=</span> <span class="s">mako</span>
<span class="na">Module</span> <span class="o">=</span> <span class="s">mako</span>

<span class="k">[Documentation]</span>
<span class="na">Author</span> <span class="o">=</span> <span class="s">Roberto Alsina</span>
<span class="na">Version</span> <span class="o">=</span> <span class="s">0.1</span>
<span class="na">Website</span> <span class="o">=</span> <span class="s">https://getnikola.com</span>
<span class="na">Description</span> <span class="o">=</span> <span class="s">Support for Mako templates.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to publish your plugin on the Plugin Index, <a class="reference external" href="https://github.com/getnikola/plugins/blob/master/README.md">read
the docs for the Index</a>
(and the .plugin file examples and explanations).</p>
</div>
<p>You will have to replace “mako” with your template system’s name, and other data
in the obvious ways.</p>
<p>The “Module” option is the name of the module, which has to look something like this,
a stub for a hypothetical system called “Templater”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nikola.plugin_categories</span> <span class="kn">import</span> <span class="n">TemplateSystem</span>

<span class="c1"># You have to inherit TemplateSystem</span>

<span class="k">class</span> <span class="nc">TemplaterTemplates</span><span class="p">(</span><span class="n">TemplateSystem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for Templater templates.&quot;&quot;&quot;</span>

    <span class="c1"># name has to match Name in the .plugin file</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;templater&quot;</span>

    <span class="c1"># A list of directories where the templates will be</span>
    <span class="c1"># located. Most template systems have some sort of</span>
    <span class="c1"># template loading tool that can use this.</span>
    <span class="k">def</span> <span class="nf">set_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">cache_folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the list of folders where templates are located and cache.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># You *must* implement this, even if to return []</span>
    <span class="c1"># It should return a list of all the files that,</span>
    <span class="c1"># when changed, may affect the template&#39;s output.</span>
    <span class="c1"># usually this involves template inheritance and</span>
    <span class="c1"># inclusion.</span>
    <span class="k">def</span> <span class="nf">template_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns filenames which are dependencies for a template.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">output_name</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders template to a file using context.</span>

<span class="sd">        This must save the data to output_name *and* return it</span>
<span class="sd">        so that the caller may do additional processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># The method that does the actual rendering.</span>
    <span class="c1"># template_name is the name of the template file,</span>
    <span class="c1"># context is a dictionary containing the data the template</span>
    <span class="c1"># uses for rendering.</span>
    <span class="k">def</span> <span class="nf">render_template_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders template to a string using context. &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">inject_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Injects the directory with the lowest priority in the</span>
<span class="sd">        template search mechanism.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>You can see a real example in <a class="reference external" href="https://github.com/getnikola/nikola/blob/master/nikola/plugins/template/jinja.py">the Jinja plugin</a></p>
</section>
<section id="task-plugins">
<h3><a class="toc-backref" href="#id5"><span class="section-number">7.1.3. </span>Task Plugins</a><a class="headerlink" href="#task-plugins" title="Permalink to this headline">¶</a></h3>
<p>If you want to do something that depends on the data in your site, you
probably want to do a <code class="docutils literal notranslate"><span class="pre">Task</span></code> plugin, which will make it be part of the
<code class="docutils literal notranslate"><span class="pre">nikola</span> <span class="pre">build</span></code> command. These are the currently available tasks, all
provided by plugins:</p>
<aside class="sidebar">
<p class="sidebar-title">Other Tasks</p>
<p>There are also <code class="docutils literal notranslate"><span class="pre">LateTask</span></code> plugins, which are executed later,
and <code class="docutils literal notranslate"><span class="pre">TaskMultiplier</span></code> plugins that take a task and create
more tasks out of it.</p>
</aside>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nikola list
<span class="go">Scanning posts....done!</span>
<span class="go">copy_assets</span>
<span class="go">copy_files</span>
<span class="go">create_bundles</span>
<span class="go">post_render</span>
<span class="go">redirect</span>
<span class="go">render_galleries</span>
<span class="go">render_listings</span>
<span class="go">render_pages</span>
<span class="go">render_posts</span>
<span class="go">render_site</span>
<span class="go">render_sources</span>
<span class="go">render_taxonomies</span>
<span class="go">robots_file</span>
<span class="go">scale_images</span>
<span class="go">sitemap</span>
</pre></div>
</div>
<p>These have access to the <code class="docutils literal notranslate"><span class="pre">site</span></code> object which contains your timeline and
your configuration.</p>
<p>The critical bit of Task plugins is their <code class="docutils literal notranslate"><span class="pre">gen_tasks</span></code> method, which <code class="docutils literal notranslate"><span class="pre">yields</span></code>
<a class="reference external" href="https://pydoit.org/tasks.html">doit tasks</a>.</p>
<p>The details of how to handle dependencies, etc., are a bit too much for this
document, so I’ll just leave you with an example, the <code class="docutils literal notranslate"><span class="pre">copy_assets</span></code> task.
First the <code class="docutils literal notranslate"><span class="pre">task_copy_assets.plugin</span></code> file, which you should copy and edit
in the logical ways:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Core]</span>
<span class="na">Name</span> <span class="o">=</span> <span class="s">copy_assets</span>
<span class="na">Module</span> <span class="o">=</span> <span class="s">task_copy_assets</span>

<span class="k">[Documentation]</span>
<span class="na">Author</span> <span class="o">=</span> <span class="s">Roberto Alsina</span>
<span class="na">Version</span> <span class="o">=</span> <span class="s">0.1</span>
<span class="na">Website</span> <span class="o">=</span> <span class="s">https://getnikola.com</span>
<span class="na">Description</span> <span class="o">=</span> <span class="s">Copy theme assets into output.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to publish your plugin on the Plugin Index, <a class="reference external" href="https://github.com/getnikola/plugins/blob/master/README.md">read
the docs for the Index</a>
(and the .plugin file examples and explanations).</p>
</div>
<p>And the <code class="docutils literal notranslate"><span class="pre">task_copy_assets.py</span></code> file, in its entirety:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">nikola.plugin_categories</span> <span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">nikola</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="c1"># Have to inherit Task to be a task plugin</span>
<span class="k">class</span> <span class="nc">CopyAssets</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy theme assets into output.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;copy_assets&quot;</span>

    <span class="c1"># This yields the tasks</span>
    <span class="k">def</span> <span class="nf">gen_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create tasks to copy the assets of the whole theme chain.</span>

<span class="sd">        If a file is present on two themes, use the version</span>
<span class="sd">        from the &quot;youngest&quot; theme.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># I put all the configurations and data the plugin uses</span>
        <span class="c1"># in a dictionary because utils.config_changed will</span>
        <span class="c1"># make it so that if these change, this task will be</span>
        <span class="c1"># marked out of date, and run again.</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;themes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">THEMES</span><span class="p">,</span>
            <span class="s2">&quot;output_folder&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;OUTPUT_FOLDER&#39;</span><span class="p">],</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;FILTERS&#39;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">theme_name</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;themes&#39;</span><span class="p">]:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_theme_path</span><span class="p">(</span><span class="n">theme_name</span><span class="p">),</span> <span class="s1">&#39;assets&#39;</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;output_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;assets&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">tasks</span><span class="p">[</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">task</span>
                <span class="n">task</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uptodate&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> \
                    <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">config_changed</span><span class="p">(</span><span class="n">kw</span><span class="p">)]</span>
                <span class="n">task</span><span class="p">[</span><span class="s1">&#39;basename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># If your task generates files, please do this.</span>
                <span class="k">yield</span> <span class="n">utils</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="pagecompiler-plugins">
<h3><a class="toc-backref" href="#id6"><span class="section-number">7.1.4. </span>PageCompiler Plugins</a><a class="headerlink" href="#pagecompiler-plugins" title="Permalink to this headline">¶</a></h3>
<p>These plugins implement markup languages, they take sources for posts or pages and
create HTML or other output files. A good example is <a class="reference external" href="https://github.com/getnikola/plugins/tree/master/v8/misaka">the misaka plugin</a> or the built-in
compiler plugins.</p>
<p>They must provide:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">compile</span></code></dt><dd><p>Function that builds a file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">create_post</span></code></dt><dd><p>Function that creates an empty file with some metadata in it.</p>
</dd>
</dl>
<p>If the compiler produces something other than HTML files, it should also implement <code class="docutils literal notranslate"><span class="pre">extension</span></code> which
returns the preferred extension for the output file.</p>
<p>These plugins can also be used to extract metadata from a file. To do so, the
plugin must set <code class="docutils literal notranslate"><span class="pre">supports_metadata</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> and implement <code class="docutils literal notranslate"><span class="pre">read_metadata</span></code> that will return a dict containing the
metadata contained in the file. Optionally, it may list <code class="docutils literal notranslate"><span class="pre">metadata_conditions</span></code> (see <a class="reference internal" href="#metadataextractor-plugins">MetadataExtractor Plugins</a> below)</p>
</section>
<section id="metadataextractor-plugins">
<h3><a class="toc-backref" href="#id7"><span class="section-number">7.1.5. </span>MetadataExtractor Plugins</a><a class="headerlink" href="#metadataextractor-plugins" title="Permalink to this headline">¶</a></h3>
<p>Plugins that extract metadata from posts. If they are based on post content,
they must implement <code class="docutils literal notranslate"><span class="pre">_extract_metadata_from_text</span></code> (takes source of a post
returns a dict of metadata).  They may also implement
<code class="docutils literal notranslate"><span class="pre">split_metadata_from_text</span></code>, <code class="docutils literal notranslate"><span class="pre">extract_text</span></code>. If they are based on filenames,
they only need <code class="docutils literal notranslate"><span class="pre">extract_filename</span></code>. If <code class="docutils literal notranslate"><span class="pre">support_write</span></code> is set to True,
<code class="docutils literal notranslate"><span class="pre">write_metadata</span></code> must be implemented.</p>
<p>Every extractor must be configured properly. The <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">source</span></code> (from the
<code class="docutils literal notranslate"><span class="pre">MetaSource</span></code> enum in <code class="docutils literal notranslate"><span class="pre">metadata_extractors</span></code>) and <code class="docutils literal notranslate"><span class="pre">priority</span></code>
(<code class="docutils literal notranslate"><span class="pre">MetaPriority</span></code>) fields are mandatory.  There might also be a list of
<code class="docutils literal notranslate"><span class="pre">conditions</span></code> (tuples of <code class="docutils literal notranslate"><span class="pre">MetaCondition,</span> <span class="pre">arg</span></code>), used to check if an
extractor can provide metadata, a compiled regular expression used to split
metadata (<code class="docutils literal notranslate"><span class="pre">split_metadata_re</span></code>, may be <code class="docutils literal notranslate"><span class="pre">None</span></code>, used by default
<code class="docutils literal notranslate"><span class="pre">split_metadata_from_text</span></code>), a list of <code class="docutils literal notranslate"><span class="pre">requirements</span></code> (3-tuples: import
name, pip name, friendly name), <code class="docutils literal notranslate"><span class="pre">map_from</span></code> (name of <code class="docutils literal notranslate"><span class="pre">METADATA_MAPPING</span></code> to
use, if any) and <code class="docutils literal notranslate"><span class="pre">supports_write</span></code> (whether the extractor supports writing
metadata in the desired format).</p>
<p>For more details, see the definition in  <code class="docutils literal notranslate"><span class="pre">plugin_categories.py</span></code> and default extractors in <code class="docutils literal notranslate"><span class="pre">metadata_extractors.py</span></code>.</p>
</section>
<section id="restextension-plugins">
<h3><a class="toc-backref" href="#id8"><span class="section-number">7.1.6. </span>RestExtension Plugins</a><a class="headerlink" href="#restextension-plugins" title="Permalink to this headline">¶</a></h3>
<p>Implement directives for reStructuredText, see <a class="reference external" href="https://github.com/getnikola/nikola/blob/master/nikola/plugins/compile/rest/media.py">media.py</a> for a simple example.</p>
<p>If your output depends on a config value, you need to make your post record a
dependency on a pseudo-path, like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>####MAGIC####CONFIG:OPTIONNAME
</pre></div>
</div>
<p>Then, whenever the <code class="docutils literal notranslate"><span class="pre">OPTIONNAME</span></code> option is changed in conf.py, the file will be rebuilt.</p>
<p>If your directive depends or may depend on the whole timeline (like the
<code class="docutils literal notranslate"><span class="pre">post-list</span></code> directive, where adding new posts to the site could make it
stale), you should record a dependency on the pseudo-path
<code class="docutils literal notranslate"><span class="pre">####MAGIC####TIMELINE</span></code>.</p>
</section>
<section id="markdownextension-plugins">
<h3><a class="toc-backref" href="#id9"><span class="section-number">7.1.7. </span>MarkdownExtension Plugins</a><a class="headerlink" href="#markdownextension-plugins" title="Permalink to this headline">¶</a></h3>
<p>Implement Markdown extensions, see <a class="reference external" href="https://github.com/getnikola/nikola/blob/master/nikola/plugins/compile/markdown/mdx_nikola.py">mdx_nikola.py</a> for a simple example.</p>
<p>Note that Python markdown extensions are often also available as separate
packages. This is only meant to ship extensions along with Nikola.</p>
</section>
<section id="signalhandler-plugins">
<h3><a class="toc-backref" href="#id10"><span class="section-number">7.1.8. </span>SignalHandler Plugins</a><a class="headerlink" href="#signalhandler-plugins" title="Permalink to this headline">¶</a></h3>
<p>These plugins extend the <code class="docutils literal notranslate"><span class="pre">SignalHandler</span></code> class and connect to one or more
signals via <a class="reference external" href="https://pythonhosted.org/blinker/">blinker</a>.</p>
<p>The easiest way to do this is to reimplement <code class="docutils literal notranslate"><span class="pre">set_site()</span></code> and just connect to
whatever signals you want there.</p>
<p>Currently Nikola emits the following signals:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">sighandlers_loaded</span></code></dt><dd><p>Right after SignalHandler plugin activation.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">initialized</span></code></dt><dd><p>When all tasks are loaded.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">configured</span></code></dt><dd><p>When all the configuration file is processed. Note that plugins are activated before this is emitted.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">scanned</span></code></dt><dd><p>After posts are scanned.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">new_post</span></code> / <code class="docutils literal notranslate"><span class="pre">new_page</span></code></dt><dd><p>When a new post is created, using the <code class="docutils literal notranslate"><span class="pre">nikola</span> <span class="pre">new_post</span></code>/<code class="docutils literal notranslate"><span class="pre">nikola</span> <span class="pre">new_page</span></code> commands.  The signal
data contains the path of the file, and the metadata file (if there is one).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">existing_post</span></code> / <code class="docutils literal notranslate"><span class="pre">existing_page</span></code></dt><dd><p>When a new post fails to be created due to a title conflict. Contains the same data as <code class="docutils literal notranslate"><span class="pre">new_post</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">deployed</span></code></dt><dd><p>When the <code class="docutils literal notranslate"><span class="pre">nikola</span> <span class="pre">deploy</span></code> command is run, and there is at least one new
entry/post since <code class="docutils literal notranslate"><span class="pre">last_deploy</span></code>.  The signal data is of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="s1">&#39;last_deploy: # datetime object for the last deployed time,</span>
 <span class="s1">&#39;new_deploy&#39;</span><span class="p">:</span> <span class="c1"># datetime object for the current deployed time,</span>
 <span class="s1">&#39;clean&#39;</span><span class="p">:</span> <span class="c1"># whether there was a record of a last deployment,</span>
 <span class="s1">&#39;deployed&#39;</span><span class="p">:</span> <span class="c1"># all files deployed after the last deploy,</span>
 <span class="s1">&#39;undeployed&#39;</span><span class="p">:</span> <span class="c1"># all files not deployed since they are either future posts/drafts</span>
<span class="p">}</span>
</pre></div>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">compiled</span></code></dt><dd><p>When a post/page is compiled from its source to html, before anything else is done with it.  The signal
data is in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="c1"># the path to the source file</span>
 <span class="s1">&#39;dest&#39;</span><span class="p">:</span> <span class="c1"># the path to the cache file for the post/page</span>
 <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="c1"># the Post object for the post/page</span>
<span class="p">}</span>
</pre></div>
</div>
</dd>
</dl>
<p>One example is the <a class="reference external" href="https://github.com/getnikola/plugins/tree/master/v7/deploy_hooks">deploy_hooks plugin.</a></p>
</section>
<section id="configplugin-plugins">
<h3><a class="toc-backref" href="#id11"><span class="section-number">7.1.9. </span>ConfigPlugin Plugins</a><a class="headerlink" href="#configplugin-plugins" title="Permalink to this headline">¶</a></h3>
<p>Does nothing specific, can be used to modify the site object (and thus the config).</p>
<p>Put all the magic you want in <code class="docutils literal notranslate"><span class="pre">set_site()</span></code>, and don’t forget to run the one
from <code class="docutils literal notranslate"><span class="pre">super()</span></code>. Example plugin: <a class="reference external" href="https://github.com/getnikola/plugins/tree/master/v7/navstories">navstories</a></p>
</section>
<section id="commentsystem-plugins">
<h3><a class="toc-backref" href="#id12"><span class="section-number">7.1.10. </span>CommentSystem Plugins</a><a class="headerlink" href="#commentsystem-plugins" title="Permalink to this headline">¶</a></h3>
<p>Can be used to add a new comment system. (It doesn’t do anything by itself.) It’s expected to provide templates named <code class="docutils literal notranslate"><span class="pre">comment_helper_foo.tmpl</span></code>.</p>
<p>Example plugin: <a class="reference external" href="https://github.com/getnikola/plugins/tree/master/v8/cactuscomments">cactuscomments</a></p>
</section>
<section id="shortcode-plugins">
<h3><a class="toc-backref" href="#id13"><span class="section-number">7.1.11. </span>Shortcode Plugins</a><a class="headerlink" href="#shortcode-plugins" title="Permalink to this headline">¶</a></h3>
<p>Shortcode Plugins are a simple way to create a custom shortcode handler.
By default, the <code class="docutils literal notranslate"><span class="pre">set_site</span></code> method will register the <code class="docutils literal notranslate"><span class="pre">handler</span></code> method as a
shortcode with the plugin’s <code class="docutils literal notranslate"><span class="pre">name</span></code> as the shortcode name.</p>
<p>See the <a class="reference internal" href="#shortcodes">Shortcodes</a> section for more details on shortcodes.</p>
</section>
<section id="postscanner-plugins">
<h3><a class="toc-backref" href="#id14"><span class="section-number">7.1.12. </span>PostScanner Plugins</a><a class="headerlink" href="#postscanner-plugins" title="Permalink to this headline">¶</a></h3>
<p>Get posts and pages from “somewhere” to be added to the timeline.
There are currently two plugins for this: the built-in <code class="docutils literal notranslate"><span class="pre">scan_posts</span></code>, and
<code class="docutils literal notranslate"><span class="pre">pkgindex_scan</span></code> (in the Plugin Index), which is used to treat .plugin/.theme
+ README.md as posts to generate the Plugin and Theme Indexes.</p>
</section>
</section>
<section id="plugin-index">
<h2><a class="toc-backref" href="#id15"><span class="section-number">7.2. </span>Plugin Index</a><a class="headerlink" href="#plugin-index" title="Permalink to this headline">¶</a></h2>
<p>There is a <a class="reference external" href="https://plugins.getnikola.com/">plugin index</a>, which stores all
of the plugins for Nikola people wanted to share with the world.</p>
<p>You may want to read the <a class="reference external" href="https://github.com/getnikola/plugins/blob/master/README.md">README for the Index</a> if you want to
publish your package there.</p>
</section>
<section id="path-link-resolution-mechanism">
<h2><a class="toc-backref" href="#id16"><span class="section-number">7.3. </span>Path/Link Resolution Mechanism</a><a class="headerlink" href="#path-link-resolution-mechanism" title="Permalink to this headline">¶</a></h2>
<p>Any plugin can register a function using <code class="docutils literal notranslate"><span class="pre">Nikola.register_path_handler</span></code> to
allow resolution of paths and links. These are useful for templates, which
can access them via <code class="docutils literal notranslate"><span class="pre">_link</span></code>.</p>
<p>For example, you can always get a link to the path for the feed of the “foo” tag
by using <code class="docutils literal notranslate"><span class="pre">_link('tag_rss',</span> <span class="pre">'foo')</span></code> or the <code class="docutils literal notranslate"><span class="pre">link://tag_rss/foo</span></code> URL.</p>
<p>Here’s the relevant code from the tag plugin.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In set_site</span>
<span class="n">site</span><span class="o">.</span><span class="n">register_path_handler</span><span class="p">(</span><span class="s1">&#39;tag_rss&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_rss_path</span><span class="p">)</span>

<span class="c1"># And these always take name and lang as arguments and return a list of</span>
<span class="c1"># path elements.</span>
<span class="k">def</span> <span class="nf">tag_rss_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TRANSLATIONS&#39;</span><span class="p">][</span><span class="n">lang</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TAG_PATH&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">slugify_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">]</span> <span class="k">if</span>
            <span class="n">_f</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="template-hooks">
<h2><a class="toc-backref" href="#id17"><span class="section-number">7.4. </span>Template Hooks</a><a class="headerlink" href="#template-hooks" title="Permalink to this headline">¶</a></h2>
<p>Plugins can use a hook system for adding stuff into templates.  In order to use
it, a plugin must register itself.  The following hooks currently exist:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">extra_head</span></code> (not equal to the config option!)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">body_end</span></code> (not equal to the config option!)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">page_header</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">menu</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">menu_alt</span></code> (right-side menu in bootstrap, after <code class="docutils literal notranslate"><span class="pre">menu</span></code> in base)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">page_footer</span></code></p></li>
</ul>
<p>For example, in order to register a script into <code class="docutils literal notranslate"><span class="pre">extra_head</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In set_site</span>
<span class="n">site</span><span class="o">.</span><span class="n">template_hooks</span><span class="p">[</span><span class="s1">&#39;extra_head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;script src=&quot;/assets/js/fancyplugin.js&quot;&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is also another API available.  It allows use of dynamically generated
HTML:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In set_site</span>
<span class="k">def</span> <span class="nf">generate_html_bit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;js&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate HTML for an asset.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;script src=&quot;/assets/</span><span class="si">{t}</span><span class="s1">/</span><span class="si">{n}</span><span class="s1">.</span><span class="si">{t}</span><span class="s1">&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">ftype</span><span class="p">)</span>

<span class="n">site</span><span class="o">.</span><span class="n">template_hooks</span><span class="p">[</span><span class="s1">&#39;extra_head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generate_html_bit</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;fancyplugin&#39;</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The second argument to <code class="docutils literal notranslate"><span class="pre">append()</span></code> is used to determine whether the function
needs access to the current template context and the site.  If it is set to
<code class="docutils literal notranslate"><span class="pre">True</span></code>, the function will also receive <code class="docutils literal notranslate"><span class="pre">site</span></code> and <code class="docutils literal notranslate"><span class="pre">context</span></code> keyword
arguments.  Example use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In set_site</span>
<span class="k">def</span> <span class="nf">greeting</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">endswith</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Greet someone.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;en&#39;</span><span class="p">:</span>
        <span class="n">greet</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Hello&#39;</span>
    <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;es&#39;</span><span class="p">:</span>
        <span class="n">greet</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;¡Hola&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39; BLOG_TITLE = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;BLOG_TITLE&#39;</span><span class="p">](</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;&lt;h3&gt;</span><span class="si">{greet}</span><span class="s1"> </span><span class="si">{addr}{endswith}</span><span class="s1">&lt;/h3&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">greet</span><span class="o">=</span><span class="n">greet</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span>
    <span class="n">endswith</span><span class="o">=</span><span class="n">endswith</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>

<span class="n">site</span><span class="o">.</span><span class="n">template_hooks</span><span class="p">[</span><span class="s1">&#39;page_header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Nikola Tesla&#39;</span><span class="p">,</span> <span class="n">endswith</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Dependencies for template hooks:</p>
<ul class="simple">
<li><p>if the input is a string, the string value, alongside arguments to <code class="docutils literal notranslate"><span class="pre">append</span></code>, is used for calculating dependencies</p></li>
<li><p>if the input is a callable, it attempts <code class="docutils literal notranslate"><span class="pre">input.template_registry_identifier</span></code>, then <code class="docutils literal notranslate"><span class="pre">input.__doc__</span></code>, and if neither is available, it uses a static string.</p></li>
</ul>
<p>Make sure to provide at least a docstring, or a identifier, to ensure rebuilds work properly.</p>
</section>
<section id="shortcodes">
<h2><a class="toc-backref" href="#id18"><span class="section-number">7.5. </span>Shortcodes</a><a class="headerlink" href="#shortcodes" title="Permalink to this headline">¶</a></h2>
<p>Some (hopefully all) markup compilers support shortcodes in these forms:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{{% raw %}}{{% foo %}}{{% /raw %}}  # No arguments
{{% raw %}{{% foo bar %}}{{% /raw %}}  # One argument, containing &quot;bar&quot;
{{% raw %}{{% foo bar baz=bat %}}{{% /raw %}}  # Two arguments, one containing &quot;bar&quot;, one called &quot;baz&quot; containing &quot;bat&quot;

{{% raw %}{{% foo %}}Some text{{% /foo %}}{{% /raw %}}  # one argument called &quot;data&quot; containing &quot;Some text&quot;
</pre></div>
</div>
<p>So, if you are creating a plugin that generates markup, it may be a good idea
to register it as a shortcode in addition of to restructured text directive or
markdown extension, thus making it available to all markup formats.</p>
<p>To implement your own shortcodes from a plugin, you can create a plugin inheriting <code class="docutils literal notranslate"><span class="pre">ShortcodePlugin</span></code>.
By default, the <code class="docutils literal notranslate"><span class="pre">set_site</span></code> method will register the <code class="docutils literal notranslate"><span class="pre">handler</span></code> method as a
shortcode with the plugin’s <code class="docutils literal notranslate"><span class="pre">name</span></code> as the shortcode name. To have other
shortcode names, you can call
<code class="docutils literal notranslate"><span class="pre">Nikola.register_shortcode(name,</span> <span class="pre">func)</span></code> with the following arguments:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code>:</dt><dd><p>Name of the shortcode (“foo” in the examples above)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">func</span></code>:</dt><dd><p>A function that will handle the shortcode</p>
</dd>
</dl>
<p>The shortcode handler <strong>must</strong> return a two-element tuple, <code class="docutils literal notranslate"><span class="pre">(output,</span> <span class="pre">dependencies)</span></code></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">output</span></code>:</dt><dd><p>The text that will replace the shortcode in the document.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dependencies</span></code>:</dt><dd><p>A list of all the files on disk which will make the output be considered
out of date. For example, if the shortcode uses a template, it should be
the path to the template file.</p>
</dd>
</dl>
<p>The shortcode handler <strong>must</strong> accept the following named arguments (or
variable keyword arguments):</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">site</span></code>:</dt><dd><p>An instance of the Nikola class, to access site state</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">data</span></code>:</dt><dd><p>If the shortcut is used as opening/closing tags, it will be the text
between them, otherwise <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lang</span></code>:</dt><dd><p>The current language.</p>
</dd>
</dl>
<p>If the shortcode tag has arguments of the form <code class="docutils literal notranslate"><span class="pre">foo=bar</span></code> they will be
passed as named arguments. Everything else will be passed as positional
arguments in the function call.</p>
<p>So, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="o">%</span> <span class="n">raw</span> <span class="o">%</span><span class="p">}}{{</span><span class="o">%</span> <span class="n">foo</span> <span class="n">bar</span> <span class="n">baz</span><span class="o">=</span><span class="n">bat</span> <span class="n">beep</span> <span class="o">%</span><span class="p">}}</span><span class="n">Some</span> <span class="n">text</span><span class="p">{{</span><span class="o">%</span> <span class="o">/</span><span class="n">foo</span> <span class="o">%</span><span class="p">}}{{</span><span class="o">%</span> <span class="o">/</span><span class="n">raw</span> <span class="o">%</span><span class="p">}}</span>
</pre></div>
</div>
<p>Assuming you registered <code class="docutils literal notranslate"><span class="pre">foo_handler</span></code> as the handler function for the
shortcode named <code class="docutils literal notranslate"><span class="pre">foo</span></code>, this will result in the following call when the above
shortcode is encountered:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo_handler</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="s2">&quot;beep&quot;</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="s2">&quot;bat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;Some text&quot;</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="n">whatever</span><span class="p">)</span>
</pre></div>
</div>
<section id="template-based-shortcodes">
<h3><a class="toc-backref" href="#id19"><span class="section-number">7.5.1. </span>Template-based Shortcodes</a><a class="headerlink" href="#template-based-shortcodes" title="Permalink to this headline">¶</a></h3>
<p>Another way to define a new shortcode is to add a template file to the
<code class="docutils literal notranslate"><span class="pre">shortcodes</span></code> directory of your site. The template file must have the
shortcode name as the basename and the extension <code class="docutils literal notranslate"><span class="pre">.tmpl</span></code>. For example, if you
want to add a new shortcode named <code class="docutils literal notranslate"><span class="pre">foo</span></code>, create the template file as
<code class="docutils literal notranslate"><span class="pre">shortcodes/foo.tmpl</span></code>.</p>
<p>When the shortcode is encountered, the matching template will be rendered with
its context provided by the arguments given in the shortcode. Keyword arguments
are passed directly, i.e. the key becomes the variable name in the template
namespace with a matching string value. Non-keyword arguments are passed as
string values in a tuple named <code class="docutils literal notranslate"><span class="pre">_args</span></code>. As for normal shortcodes with a
handler function, <code class="docutils literal notranslate"><span class="pre">site</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code> will be added to the keyword arguments.</p>
<p>Example:</p>
<p>The following shortcode:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{{% raw %}}{{% foo bar=&quot;baz&quot; spam %}}{{% /raw %}}
</pre></div>
</div>
<p>With a template in <code class="docutils literal notranslate"><span class="pre">shortcodes/foo.tmpl</span></code> with this content (using Jinja2
syntax in this example)</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="x">&lt;div class=&quot;</span><span class="cp">{{</span> <span class="nv">_args</span><span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="k">if</span> <span class="nv">_args</span> <span class="k">else</span> <span class="s1">&#39;ham&#39;</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">bar</span> <span class="cp">}}</span><span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Will result in this output</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;spam&quot;</span><span class="p">&gt;</span>baz<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="state-and-cache">
<h2><a class="toc-backref" href="#id20"><span class="section-number">7.6. </span>State and Cache</a><a class="headerlink" href="#state-and-cache" title="Permalink to this headline">¶</a></h2>
<p>Sometimes your plugins will need to cache things to speed up further actions. Here are the conventions for that:</p>
<ul class="simple">
<li><p>If it’s a file, put it somewhere in <code class="docutils literal notranslate"><span class="pre">self.site.config['CACHE_FOLDER']</span></code> (defaults to <code class="docutils literal notranslate"><span class="pre">cache/</span></code>.</p></li>
<li><p>If it’s a value, use <code class="docutils literal notranslate"><span class="pre">self.site.cache.set(key,</span> <span class="pre">value)</span></code> to set it and <code class="docutils literal notranslate"><span class="pre">self.site.cache.get(key)</span></code> to get it.
The key should be a string, the value should be json-encodable (so, be careful with datetime objects)</p></li>
</ul>
<p>The values and files you store there can <strong>and will</strong> be deleted sometimes by the user. They should always be
things you can reconstruct without lossage. They are throwaways.</p>
<p>On the other hand, sometimes you want to save something that is <strong>not</strong> a throwaway. These are things that may
change the output, so the user should not delete them. We call that <strong>state</strong>. To save state:</p>
<ul class="simple">
<li><p>If it’s a file, put it somewhere in the working directory. Try not to do that please.</p></li>
<li><p>If it’s a value, use <code class="docutils literal notranslate"><span class="pre">self.site.state.set(key,</span> <span class="pre">value)</span></code> to set it and <code class="docutils literal notranslate"><span class="pre">self.state.cache.get(key)</span></code> to get it.
The key should be a string, the value should be json-encodable (so, be careful with datetime objects)</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> and <code class="docutils literal notranslate"><span class="pre">state</span></code> objects are rather simplistic, and that’s intentional. They have no default values: if
the key is not there, you will get <code class="docutils literal notranslate"><span class="pre">None</span></code> and like it. They are meant to be both threadsafe, but hey, who can
guarantee that sort of thing?</p>
<p>There are no sections, and no access protection, so let’s not use it to store passwords and such. Use responsibly.</p>
</section>
<section id="logging">
<h2><a class="toc-backref" href="#id21"><span class="section-number">7.7. </span>Logging</a><a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>Plugins often need to produce messages to the screen. All plugins get a logger object (<code class="docutils literal notranslate"><span class="pre">self.logger</span></code>) by default,
configured to work with Nikola (logging level, colorful output, plugin name as the logger name). If you need, you can
also use the global (<code class="docutils literal notranslate"><span class="pre">nikola.utils.LOGGER</span></code>) logger, or you can instantiate custom loggers with
<code class="docutils literal notranslate"><span class="pre">nikola.utils.get_logger</span></code> or the <code class="docutils literal notranslate"><span class="pre">nikola.log</span></code> module.</p>
</section>
<section id="template-and-dependency-injection">
<h2><a class="toc-backref" href="#id22"><span class="section-number">7.8. </span>Template and Dependency Injection</a><a class="headerlink" href="#template-and-dependency-injection" title="Permalink to this headline">¶</a></h2>
<p>Plugins have access to two injection facilities.</p>
<p>If your plugin needs custom templates for its features (adding pages, displaying stuff, etc.), you can put them in the
<code class="docutils literal notranslate"><span class="pre">templates/mako</span></code> and <code class="docutils literal notranslate"><span class="pre">templates/jinja</span></code> subfolders in your plugin’s folder. Note that those templates have a very low
priority, so that users can override your plugin’s templates with their own.</p>
<p>If your plugin needs to inject dependencies, the <code class="docutils literal notranslate"><span class="pre">inject_dependency(target,</span> <span class="pre">dependency)</span></code> function can be used to add a
<code class="docutils literal notranslate"><span class="pre">dependency</span></code> for tasks which basename == <code class="docutils literal notranslate"><span class="pre">target</span></code>. This facility should be limited to cases which really need it,
consider other facilities first (eg. adding post dependencies).</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/nikola-50px-transparent.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7. Extending Nikola</a><ul>
<li><a class="reference internal" href="#available-plugin-categories">7.1. Available Plugin Categories</a><ul>
<li><a class="reference internal" href="#command-plugins">7.1.1. Command Plugins</a></li>
<li><a class="reference internal" href="#templatesystem-plugins">7.1.2. TemplateSystem Plugins</a></li>
<li><a class="reference internal" href="#task-plugins">7.1.3. Task Plugins</a></li>
<li><a class="reference internal" href="#pagecompiler-plugins">7.1.4. PageCompiler Plugins</a></li>
<li><a class="reference internal" href="#metadataextractor-plugins">7.1.5. MetadataExtractor Plugins</a></li>
<li><a class="reference internal" href="#restextension-plugins">7.1.6. RestExtension Plugins</a></li>
<li><a class="reference internal" href="#markdownextension-plugins">7.1.7. MarkdownExtension Plugins</a></li>
<li><a class="reference internal" href="#signalhandler-plugins">7.1.8. SignalHandler Plugins</a></li>
<li><a class="reference internal" href="#configplugin-plugins">7.1.9. ConfigPlugin Plugins</a></li>
<li><a class="reference internal" href="#commentsystem-plugins">7.1.10. CommentSystem Plugins</a></li>
<li><a class="reference internal" href="#shortcode-plugins">7.1.11. Shortcode Plugins</a></li>
<li><a class="reference internal" href="#postscanner-plugins">7.1.12. PostScanner Plugins</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plugin-index">7.2. Plugin Index</a></li>
<li><a class="reference internal" href="#path-link-resolution-mechanism">7.3. Path/Link Resolution Mechanism</a></li>
<li><a class="reference internal" href="#template-hooks">7.4. Template Hooks</a></li>
<li><a class="reference internal" href="#shortcodes">7.5. Shortcodes</a><ul>
<li><a class="reference internal" href="#template-based-shortcodes">7.5.1. Template-based Shortcodes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#state-and-cache">7.6. State and Cache</a></li>
<li><a class="reference internal" href="#logging">7.7. Logging</a></li>
<li><a class="reference internal" href="#template-and-dependency-injection">7.8. Template and Dependency Injection</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="template-variables.html"
                        title="previous chapter"><span class="section-number">6. </span>Template variables</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="internals.html"
                        title="next chapter"><span class="section-number">8. </span>Nikola Internals</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/extending.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="internals.html" title="8. Nikola Internals"
             >next</a> |</li>
        <li class="right" >
          <a href="template-variables.html" title="6. Template variables"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Nikola 8.1.3 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7. </span>Extending Nikola</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2021, The Nikola Contributors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>