#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C0114,C0115,C0116,C0413,W0212,E0611,E0401,R0201


import os
import sys
import traceback


sys.path.insert(0, os.getcwd())


import opb.modules


from opb.handler import Client, Error
from opb.handler import command, parse
from opb.scanner import scanpkg, importer


class CLI(Client):

    def announce(self, txt):
        pass

    @staticmethod
    def raw(txt):
        print(txt)
        sys.stdout.flush()


def waiter():
    got = []
    for ex in Error.errors:
        traceback.print_exception(type(ex), ex, ex.__traceback__)
        got.append(ex)
    for exc in got:
        Error.errors.remove(exc)


def main():
    cfg = parse(' '.join(sys.argv[1:]))
    scanpkg(opb.modules, importer, doall=True)
    cli = CLI()
    command(cli, cfg.otxt)
    waiter()


main()
