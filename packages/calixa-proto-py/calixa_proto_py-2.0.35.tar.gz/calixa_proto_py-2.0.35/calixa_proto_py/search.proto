syntax = "proto3";

import "google/protobuf/timestamp.proto";

import "account.proto";
import "push_notification.proto";
import "billing.proto";
import "conversation.proto";
import "collaboration_entity.proto";
import "entity.proto";
import "common.proto";
import "automation_log.proto";
import "condition.proto";
import "automation.proto";
import "metric.proto";

option java_package = "io.calixa.domain.search";
option java_multiple_files = true;
option optimize_for = SPEED;

package calixa.domain.search;

message SearchParameters {
  reserved 4;
  // repeated string facetFilters = 4;
  oneof type {
    calixa.domain.common.EntityType entity = 1;
    bool automation_log = 11;
    bool action_invocation_log = 12;
  }

  string filters = 2;
  string facets = 3;
  string query = 5;
  int64 from = 6; // unused?
  int64 to = 7; // unused?

  string sort_field = 8;
  string sort_order = 9;
  bool no_augment = 10; // unused?
}

message SavedSearch {
  string saved_search_id = 1;
  string organization_user_id = 2;
  string organization_id = 3;

  string name = 4;
  SearchParameters parameters = 5;
  repeated string columns = 6;

  google.protobuf.Timestamp created_at = 20;
  google.protobuf.Timestamp updated_at = 21;
}

message SearchRequest {
  string organization_id = 1;
  int32 page = 2;
  int32 hits_per_page = 3;
  SearchParameters parameters = 4;
}

message SearchResponseFacet {
  string facet_name = 1;
  map<string, int64> values = 2;
}

message SearchResponse {
  repeated calixa.domain.entity.EntityWithRelationships entities = 2;

  repeated SearchResponseFacet facets = 100;
  int64 total_hits = 101;
  int64 page = 102;
  int64 total_pages = 103;
  int64 hits_per_page = 104;
  int64 processing_time_ms = 105;
  bool timed_out = 106;
}

message MetricWithTimeRange {
  string metric_descriptor_id = 1;
  oneof metric_range {
    calixa.domain.condition.RelativeTimeRange relative_time_range = 2;
    calixa.domain.condition.AbsoluteTimeRange absolute_time_range = 3;
  }
}

enum SortType {
  SORT_TYPE_UNSPECIFIED = 0;
  SORT_TYPE_PROPERTY = 1; // limited capability
  SORT_TYPE_METRIC = 2;
  SORT_TYPE_DELTA = 3;
  SORT_TYPE_SCORING_FUNCTION = 4;
  SORT_TYPE_JOURNEY = 5;
  SORT_TYPE_PREDICTION = 6;
}

message SearchSortField {
  SortType sort_type = 1;
  string sort_field_type = 2;
  string sort_field = 3;
  bool sort_asc = 4;
}

enum FeatureValueDistributionType {
  FEATURE_VALUE_DISTRIBUTION_TYPE_UNSPECIFIED = 0;
  FEATURE_VALUE_DISTRIBUTION_TYPE_HISTOGRAM = 1;
  FEATURE_VALUE_DISTRIBUTION_TYPE_TOP_N = 2;
}

message FeatureValueDistributionRequest {

  string organization_id = 1;
  calixa.domain.common.EntityType entity_type = 2;
  calixa.domain.condition.ConditionGroup filters = 3;

  // Only support TOPN for now
  FeatureValueDistributionType distribution_type = 4;
  int32 limit = 5; // Only used for TopN currently

  calixa.domain.condition.RelativeTimeRange timeframe = 6;

  string field = 10;

}

message FeatureValue {
  oneof value {
    string s = 1;
    int64 l = 2;
    double d = 3;
  }
  int64 count = 100;
  double fraction = 101;
}

message FeatureValueDistributionResponse {
  repeated FeatureValue distribution = 1;
  int64 total_results = 2;
  int64 distinct_values_count = 3;
}

message TrendSearchRequest {
  reserved 4, 7, 8, 9, 10; //deprecated fields
  string organization_id = 1;
  calixa.domain.common.EntityType entity_type = 2;
  calixa.domain.condition.ConditionGroup condition = 3;
  int32 page = 5;
  int32 hits_per_page = 6;
  repeated calixa.domain.condition.ConditionOrGroup columns = 11;
  repeated SearchSortField sort_fields = 12;
  calixa.domain.condition.RelativeTimeRange timeframe = 13;
  // temporary boolean to trigger
  bool isRocksetQuery = 99999;
}

enum RollupType {
  ROLLUP_TYPE_UNSPECIFIED = 0;
  ROLLUP_TYPE_EMAIL_DOMAIN = 1;
}

message TrendSearchRollupRequest {
  string organization_id = 1;
  calixa.domain.common.EntityType entity_type = 2;
  calixa.domain.condition.ConditionGroup condition = 3; // filters
  repeated MetricWithTimeRange rank_metrics = 4;
  RollupType rollup_type = 5;

  int32 page = 6;
  int32 hits_per_page = 7;
  SortType sort_type = 8 [deprecated = true];
  string sort_field_type = 9 [deprecated = true];
  // property key or metric id
  string sort_field = 10 [deprecated = true];
  bool sort_asc = 11 [deprecated = true];
  repeated calixa.domain.condition.ConditionOrGroup columns = 12;
  repeated SearchSortField sort_fields = 13;
}

message TrendSearchRollupResponse {
  string organization_id = 1;
  repeated TrendSearchRollupRow rows = 2;
}

message TrendSearchRollupRow {
  string predicate = 1; // this is domain name for now, let's see what the future holds...
  int64 accounts_count = 2;
  int64 users_count = 3;
  repeated string owners = 4; // list of owner canonical ids
  map<string, calixa.domain.metric.AggregatedMetric> aggregated_metrics = 5; // metrics
}
