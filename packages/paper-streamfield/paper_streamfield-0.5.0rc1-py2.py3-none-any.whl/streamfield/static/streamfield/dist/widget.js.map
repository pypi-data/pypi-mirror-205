{"version":3,"file":"widget.js","mappings":"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","sources":["webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/regex.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/validate.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/native.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/rng.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/stringify.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/v4.js","webpack://paper-streamfield/./streamfield/static/streamfield/src/widget.js"],"sourcesContent":["export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;","import REGEX from './regex.js';\n\nfunction validate(uuid) {\n  return typeof uuid === 'string' && REGEX.test(uuid);\n}\n\nexport default validate;","const randomUUID = typeof crypto !== 'undefined' && crypto.randomUUID && crypto.randomUUID.bind(crypto);\nexport default {\n  randomUUID\n};","// Unique ID creation requires a high quality random # generator. In the browser we therefore\n// require the crypto API and do not support built-in fallback to lower quality random number\n// generators (like Math.random()).\nlet getRandomValues;\nconst rnds8 = new Uint8Array(16);\nexport default function rng() {\n  // lazy load so that environments that need to polyfill have a chance to do so\n  if (!getRandomValues) {\n    // getRandomValues needs to be invoked in a context where \"this\" is a Crypto implementation.\n    getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto);\n\n    if (!getRandomValues) {\n      throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n    }\n  }\n\n  return getRandomValues(rnds8);\n}","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nconst byteToHex = [];\n\nfor (let i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).slice(1));\n}\n\nexport function unsafeStringify(arr, offset = 0) {\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  return (byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]]).toLowerCase();\n}\n\nfunction stringify(arr, offset = 0) {\n  const uuid = unsafeStringify(arr, offset); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  if (native.randomUUID && !buf && !options) {\n    return native.randomUUID();\n  }\n\n  options = options || {};\n  const rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (let i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return unsafeStringify(rnds);\n}\n\nexport default v4;","/* global gettext */\n/* global Sortable */\n/* global XClass */\nimport { v4 as uuid4, validate as uuid_validate } from \"uuid\";\n\nimport \"./widget.scss\";\n\nconst popupUtils = window.paperAdmin.popupUtils;\nconst modals = window.paperAdmin.modals;\n\nclass StreamField {\n    static STATUS = {\n        LOADING: \"loading\",\n        READY: \"ready\"\n    };\n\n    static CSS = {\n        field: \"stream-field\",\n        control: \"stream-field__control\",\n        blocks: \"stream-field__blocks\",\n        block: \"stream-field__block\",\n        buttons: \"stream-field__buttons\",\n        sortableHandler: \"stream-field__sortable-handler\",\n        changeBlockButton: \"stream-field__change-btn\",\n        deleteBlockButton: \"stream-field__delete-btn\",\n        dropdownItemButton: \"stream-field__dropdown-item\" // create or lookup block\n    };\n\n    constructor(element) {\n        this.field = element;\n        this.control = this.field.querySelector(`.${this.CSS.control}`);\n        this.blocks = this.field.querySelector(`.${this.CSS.blocks}`);\n        this.buttons = this.field.querySelector(`.${this.CSS.buttons}`);\n\n        this._sortable = this._initSortable();\n        this._addListeners();\n        this._updateBlockMap();\n\n        this.wrapPreloader(Promise.all([this.updateBlocks(), this.updateButtons()]));\n    }\n\n    get STATUS() {\n        return this.constructor.STATUS;\n    }\n\n    get CSS() {\n        return this.constructor.CSS;\n    }\n\n    /**\n     * @returns {Array}\n     */\n    get value() {\n        let data;\n        try {\n            data = JSON.parse(this.control.value);\n        } catch {\n            data = [];\n        }\n        return data;\n    }\n\n    /**\n     * @param {string|Array} data\n     */\n    set value(data) {\n        if (typeof data !== \"string\") {\n            data = JSON.stringify(data);\n        }\n        this.control.value = data;\n    }\n\n    /**\n     * @returns {string}\n     */\n    get status() {\n        return Object.values(this.STATUS).find(value => {\n            return this.field.classList.contains(`${this.CSS.field}--${value}`);\n        });\n    }\n\n    /**\n     * @param {string} status\n     */\n    set status(status) {\n        Object.values(this.STATUS).forEach(value => {\n            this.field.classList.toggle(`${this.CSS.field}--${value}`, status === value);\n        });\n    }\n\n    /**\n     * @returns {String[]}\n     */\n    get allowedModels() {\n        return JSON.parse(this.control.dataset.allowedModels);\n    }\n\n    /**\n     * @returns {HTMLElement[]}\n     */\n    getBlocks() {\n        return Array.from(this.blocks.querySelectorAll(`.${this.CSS.block}`));\n    }\n\n    /**\n     * @param {string} uuid\n     * @returns {Object}\n     */\n    getBlockByUUID(uuid) {\n        return this._blockMap[uuid];\n    }\n\n    destroy() {\n        if (this._sortable) {\n            this._sortable.destroy();\n        }\n\n        // TODO: remove event listeners\n    }\n\n    /**\n     * Создаёт объект для быстрого поиска блоков по UUID.\n     *\n     * @returns {Object}\n     */\n    _updateBlockMap() {\n        let hasBadBlocks = false;\n        const result = {};\n\n        const processedValue = this.value.map(record => {\n            let uuid = record[\"uuid\"];\n            if (typeof uuid === \"string\" && uuid_validate(uuid)) {\n                return (result[uuid] = record);\n            } else {\n                hasBadBlocks = true;\n                uuid = uuid4();\n                return (result[uuid] = { uuid: uuid });\n            }\n        });\n\n        this._blockMap = result;\n        if (processedValue) {\n            this.value = processedValue;\n        }\n    }\n\n    /**\n     * @returns {*}\n     * @private\n     */\n    _initSortable() {\n        return Sortable.create(this.blocks, {\n            animation: 0,\n            draggable: `.${this.CSS.block}`,\n            filter: (event, target) => {\n                if (this.status === this.STATUS.LOADING) {\n                    return true;\n                }\n\n                if (!target) {\n                    return true;\n                }\n            },\n            handle: `.${this.CSS.sortableHandler}`,\n            ghostClass: \"sortable-ghost\",\n            onEnd: () => {\n                this.save();\n            }\n        });\n    }\n\n    _addListeners() {\n        this.field.addEventListener(\"click\", event => {\n            const deleteButton = event.target.closest(`.${this.CSS.deleteBlockButton}`);\n            if (deleteButton) {\n                event.preventDefault();\n                deleteButton.disabled = true;\n\n                modals.createModal({\n                    modalClass: \"paper-modal--warning fade\",\n                    title: gettext(\"Confirm deletion\"),\n                    body: gettext(\"Are you sure you want to <b>DELETE</b> selected block from this field?\"),\n                    buttons: [\n                        {\n                            label: gettext(\"Cancel\"),\n                            buttonClass: \"btn-light\",\n                            onClick: (event, popup) => {\n                                popup.destroy();\n                            }\n                        },\n                        {\n                            autofocus: true,\n                            label: gettext(\"Delete\"),\n                            buttonClass: \"btn-danger\",\n                            onClick: (event, popup) => {\n                                popup.destroy();\n\n                                const block = deleteButton.closest(`.${this.CSS.block}`);\n                                block.remove();\n\n                                this.save();\n                                this.wrapPreloader(this.updateBlocks());\n                            }\n                        }\n                    ],\n                    onInit: function () {\n                        this.show();\n                    },\n                    onDestroy: function () {\n                        deleteButton.disabled = false;\n                    }\n                });\n            }\n\n            const changeButton = event.target.closest(`.${this.CSS.changeBlockButton}`);\n            if (changeButton) {\n                event.preventDefault();\n                const jQueryEvent = $.Event(\"django:show-related\", { href: changeButton.href });\n                $(changeButton).trigger(jQueryEvent);\n                if (!jQueryEvent.isDefaultPrevented()) {\n                    showStreamBlockPopup(changeButton);\n                }\n            }\n\n            const dropdownItem = event.target.closest(`.${this.CSS.dropdownItemButton}`);\n            if (dropdownItem) {\n                event.preventDefault();\n                const jQueryEvent = $.Event(\"django:show-related\", { href: dropdownItem.href });\n                $(dropdownItem).trigger(jQueryEvent);\n                if (!jQueryEvent.isDefaultPrevented()) {\n                    showStreamBlockPopup(dropdownItem);\n                }\n            }\n        });\n    }\n\n    /**\n     * @param {Object} block\n     * @private\n     */\n    _appendBlock(block) {\n        const uuid = block.uuid;\n        if (!uuid_validate(uuid)) {\n            throw new Error(\"Invalid UUID\");\n        }\n\n        const newValue = this.value;\n        newValue.push(block);\n        this.value = newValue;\n\n        this._blockMap[uuid] = block;\n    }\n\n    save() {\n        this.value = this.getBlocks().map(block => {\n            const uuid = block.dataset.uuid;\n            return this.getBlockByUUID(uuid);\n        });\n    }\n\n    /**\n     * @param {Promise} promise\n     * @returns {Promise}\n     */\n    wrapPreloader(promise) {\n        this.status = this.STATUS.LOADING;\n        return promise.finally(() => {\n            this.status = this.STATUS.READY;\n        });\n    }\n\n    updateBlocks() {\n        return this.renderStream({\n            allowedModels: this.allowedModels,\n            value: this.value\n        });\n    }\n\n    renderStream(data) {\n        const renderUrl = this.field.dataset.renderStreamUrl;\n        return fetch(renderUrl, {\n            method: \"POST\",\n            mode: \"same-origin\",\n            cache: \"no-store\",\n            headers: {\n                \"Content-Type\": \"application/json;charset=utf-8\"\n            },\n            body: JSON.stringify(data)\n        })\n            .then(response => {\n                if (!response.ok) {\n                    throw `${response.status} ${response.statusText}`;\n                }\n                return response.json();\n            })\n            .then(response => {\n                this.blocks.innerHTML = response.blocks;\n            })\n            .catch(reason => {\n                if (reason instanceof Error) {\n                    // JS-ошибки дублируем в консоль\n                    console.error(reason);\n                }\n                modals.showErrors(reason);\n            });\n    }\n\n    updateButtons() {\n        return this.renderButtons({\n            field_id: this.control.id,\n            allowedModels: this.allowedModels\n        });\n    }\n\n    renderButtons(data) {\n        const renderUrl = this.field.dataset.renderButtonsUrl;\n        return fetch(renderUrl, {\n            method: \"POST\",\n            mode: \"same-origin\",\n            cache: \"no-store\",\n            headers: {\n                \"Content-Type\": \"application/json;charset=utf-8\"\n            },\n            body: JSON.stringify(data)\n        })\n            .then(response => {\n                if (!response.ok) {\n                    throw `${response.status} ${response.statusText}`;\n                }\n                return response.json();\n            })\n            .then(response => {\n                this.buttons.innerHTML = response.buttons;\n            });\n    }\n}\n\nXClass.register(\"paper-streamfield\", {\n    init: function (element) {\n        element._streamField = new StreamField(element, this);\n    },\n    destroy: function (element) {\n        if (element._streamField) {\n            element._streamField.destroy();\n            delete element._streamField;\n        }\n    }\n});\n\n/**\n * @param {HTMLElement} triggeringLink\n */\nfunction showStreamBlockPopup(triggeringLink) {\n    return popupUtils.showAdminPopup(triggeringLink, /^(change|add|lookup)_/, true);\n}\n\n/**\n * @param {Window} win\n * @param {String} newId\n */\nfunction dismissAddStreamBlockPopup(win, newId) {\n    const name = popupUtils.removePopupIndex(win.name);\n    const match = /^(.+)--(.+)\\.(.+)$/.exec(name);\n    if (match) {\n        const control = document.getElementById(match[1]);\n        const field = control.closest(\".stream-field\");\n        const streamField = field && field._streamField;\n\n        streamField._appendBlock({\n            model: `${match[2]}.${match[3]}`,\n            pk: newId,\n            uuid: uuid4()\n        });\n\n        streamField.wrapPreloader(streamField.updateBlocks());\n\n        popupUtils.removeRelatedWindow(win);\n        win.close();\n    }\n}\n\n/**\n * @param {Window} win\n */\nfunction dismissChangeStreamBlockPopup(win) {\n    const name = \"change_\" + popupUtils.removePopupIndex(win.name);\n    const element = document.getElementById(name);\n    const fieldWrapper = element && element.closest(\".paper-widget\");\n    const field = fieldWrapper && fieldWrapper.firstElementChild;\n    const instance = field && field._streamField;\n\n    instance.updateBlocks();\n\n    popupUtils.removeRelatedWindow(win);\n    win.close();\n}\n\n/**\n * @param {Window} win\n * @param {String} objId\n */\nfunction dismissDeleteStreamBlockPopup(win, objId) {\n    const name = popupUtils.removePopupIndex(win.name);\n    const match = /^(.+)--(.+)\\.(.+)$/.exec(name);\n    if (match) {\n        const control = document.getElementById(match[1]);\n        const field = control.closest(\".stream-field\");\n        const streamField = field && field._streamField;\n\n        streamField.wrapPreloader(streamField.updateBlocks());\n\n        popupUtils.removeRelatedWindow(win);\n        win.close();\n    }\n}\n\n/**\n * Обёртка над Django-обработчиком `window.dismissRelatedLookupPopup`.\n * @param {Function} originalFunc\n */\nfunction dismissLookupStreamBlockPopup(originalFunc) {\n    return (win, chosenId) => {\n        const name = popupUtils.removePopupIndex(win.name);\n        const match = /^(.+)--(.+)\\.(.+)$/.exec(name);\n        if (match) {\n            const control = document.getElementById(match[1]);\n            const field = control.closest(\".stream-field\");\n            const streamField = field && field._streamField;\n\n            streamField._appendBlock({\n                model: `${match[2]}.${match[3]}`,\n                pk: chosenId,\n                uuid: uuid4()\n            });\n\n            streamField.wrapPreloader(streamField.updateBlocks());\n\n            popupUtils.removeRelatedWindow(win);\n            win.close();\n        } else {\n            originalFunc(win, chosenId);\n        }\n    };\n}\n\nwindow.dismissAddStreamBlockPopup = dismissAddStreamBlockPopup;\nwindow.dismissChangeStreamBlockPopup = dismissChangeStreamBlockPopup;\nwindow.dismissDeleteStreamBlockPopup = dismissDeleteStreamBlockPopup;\n\n// Wrap default `dismissRelatedLookupPopup`.\nwindow.dismissRelatedLookupPopup = dismissLookupStreamBlockPopup(window.dismissRelatedLookupPopup);\n"],"names":["uuid","randomUUID","crypto","bind","getRandomValues","rnds8","Uint8Array","rng","Error","byteToHex","i","push","toString","slice","unsafeStringify","arr","offset","toLowerCase","options","buf","rnds","random","popupUtils","window","paperAdmin","modals","StreamField","constructor","element","this","field","control","querySelector","CSS","blocks","buttons","_sortable","_initSortable","_addListeners","_updateBlockMap","wrapPreloader","Promise","all","updateBlocks","updateButtons","STATUS","value","data","JSON","parse","stringify","status","Object","values","find","classList","contains","forEach","toggle","allowedModels","dataset","getBlocks","Array","from","querySelectorAll","block","getBlockByUUID","_blockMap","destroy","hasBadBlocks","result","processedValue","map","record","uuid_validate","uuid4","Sortable","create","animation","draggable","filter","event","target","LOADING","handle","sortableHandler","ghostClass","onEnd","save","addEventListener","deleteButton","closest","deleteBlockButton","preventDefault","disabled","createModal","modalClass","title","gettext","body","label","buttonClass","onClick","popup","autofocus","remove","onInit","show","onDestroy","changeButton","changeBlockButton","jQueryEvent","$","Event","href","trigger","isDefaultPrevented","showStreamBlockPopup","dropdownItem","dropdownItemButton","_appendBlock","newValue","promise","finally","READY","renderStream","renderUrl","renderStreamUrl","fetch","method","mode","cache","headers","then","response","ok","statusText","json","innerHTML","catch","reason","console","error","showErrors","renderButtons","field_id","id","renderButtonsUrl","triggeringLink","showAdminPopup","originalFunc","XClass","register","init","_streamField","dismissAddStreamBlockPopup","win","newId","name","removePopupIndex","match","exec","document","getElementById","streamField","model","pk","removeRelatedWindow","close","dismissChangeStreamBlockPopup","fieldWrapper","firstElementChild","dismissDeleteStreamBlockPopup","objId","dismissRelatedLookupPopup","chosenId"],"sourceRoot":""}